@using Alicante.Client.Models
@using Alicante.Data
@implements IDisposable

@inject NavigationManager NavigationManager

<BSNavbar Color="BSColor.Light" IsFixedTop=true>
    <div class="container-fluid">
        <BSNavbarBrand Url="#">Alicante</BSNavbarBrand>
        <BSCollapse IsInNavbar="true">
            <Toggler>
                <BSNavbarToggle />
            </Toggler>
            <Content>
                <BSNav MarginEnd="Margins.Auto" MarginBottom="Margins.Small" Class="mb-lg-0">
                    <BSNavItem Url="tournament">Turneringer</BSNavItem>
                    <BSNavItem Url="player">Spillere</BSNavItem>
                    <BSNavItem Url="course">Baner</BSNavItem>
                    <BSNavItem Url="match">Matcher</BSNavItem>
                    <BSNavItem Url="result">Resultater</BSNavItem>
                    <BSNavItem Url="scores">Leaderboard</BSNavItem>
@*                     <AuthorizeView Roles="@AppRoles.Admin">
                        <BSNavItem Url="preconditions">Preconditions</BSNavItem>
                        <BSNavItem Url="logging">Logging</BSNavItem>
                        <BSNavItem Url="admin">Admin</BSNavItem>
                    </AuthorizeView> 
 *@                </BSNav>
            </Content>
        </BSCollapse>
        @if (activeTournament != null) {
            <BSNavbarBrand class="d-flex">@activeTournament.TournamentName</BSNavbarBrand>
        }
        else
        {
            <BSNavbarBrand class="d-flex">- ingen aktuel turnering -</BSNavbarBrand>
        }
        <div class="d-flex">
            <AuthorizeView Context="AuthenticationState">
                <div class="navbar-text">
                    @AuthenticationState?.User?.Identity?.Name
                    <AuthorizeView Roles="Admin">
                        <Authorized>
                            (Admin)
                        </Authorized>
                        <NotAuthorized>
                            (Read Only)
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </AuthorizeView>
             <LoginDisplay></LoginDisplay>
         </div>
    </div>
</BSNavbar>

@code {
    private string? currentUrl;

    [CascadingParameter]
    int tournamentId { get; set; }
    string tournamentName { get; set; }

    [Inject] public AppState _appState { get; set; }
    [Inject] public IRepository _repo { get; set; }
    public TournamentModel activeTournament { get; set; }

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        _appState.StateChangedHandler += OnTournamentChanged;
        activeTournament = await _repo.GetAciveTournament();
        tournamentId = activeTournament.TournamentId;
        tournamentName = activeTournament.TournamentName;
        _appState.TournamentId = activeTournament!.TournamentId;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private void OnTournamentChanged(object sender, EventArgs e)
    {
        var appState = sender as AppState;
        if (appState != null)
        {
            tournamentId = _appState.TournamentId;
            tournamentName = _appState.TournamentName;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        _appState.StateChangedHandler -= OnTournamentChanged;
    }

    private bool collapseNavMenu = true;
    private string? NavBarCssClass => collapseNavMenu ? null : "show";
    private string? NavButtonCssClass => collapseNavMenu ? "collapsed" : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }
}